# trace2pprof

## What it does

The `trace2pprof` program parses traces generated by [MAME](https://www.mamedev.org/), and converts them into profiles that can be processed using the [`pprof`](https://github.com/google/pprof) tool.

This allows you to use the full suite of `pprof` features (cli, interactive explorer, source annotation) to understand the performance of your application.

## How it works

To create the profiles, `trace2pprof` processes the trace file generated by MAME and counts how often the instruction at each address was executed. It then embeds this information into the profile for `pprof` to interpret, which will do the heavy lifting of interpreting the debug information, annotating source code, etc.

It's important to understand that this does not represent cycle count, since it purely counts instructions, but even with this restriction the profiles have been proving very useful in practice. Taking the actual instruction timings into account would be a good step toward making the profiles more accurate (see [issue #1](https://github.com/team-fullset/trace2pprof/issues/1)).

## Prerequisites

In order to build and use this tool, you need to have:

- a recent Rust toolchain (available via https://rustup.rs/)
- an installation of pprof (available via `go get` from https://github.com/google/pprof)
- a version of binutils for your target platform (e.g. m68k)

## Build

Running the following command will build the `trace2pprof` tool and install it on your machine:

```
cargo install --path .
```

## Usage

### Step 0: Compile program

Compile your program while passing the `-g` flag to `CC`, in order to emit debug information. Then create the ROM as usual.

### Step 1: Generate MAME trace

Once you have your ROM, you can start MAME in debug mode by passing the `-debug` flag.

At the point where you would like to start profiling, run the following command in the MAME debugger:

```
trace game.tr,0,noloop
```

You can stop the tracing by running the `trace off,0` command (or simply by exiting MAME).

### Step 2: Process trace and generate profile

Once you have the trace, you can generate a profile:

```
trace2pprof game.tr
```

### Step 3: Inspect profile

Now you can open the profile inspector in your web browser:

```
pprof -tools /path/to/cross/binutils/bin -http :8080 test.o profile.pb.gz
```
